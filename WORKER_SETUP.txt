# Worker Queue System - DocumentaciÃ³n

## ğŸ“‹ CÃ³mo Funciona

El worker ahora usa un sistema de **cola (queue)** para procesar las imÃ¡genes de manera asÃ­ncrona:

### 1. Cuando subes una foto (POST `/process`)
- âœ… Sube la imagen a GreenHost
- âœ… Guarda la tarea en Firebase en la colecciÃ³n `queue`
- âœ… Responde inmediatamente al usuario
- âŒ NO procesa la imagen todavÃ­a

### 2. Procesamiento manual (GET `/work`)
- ğŸ² Selecciona una imagen **aleatoria** de la cola
- ğŸ¤– La procesa con IA (Pixtral + Mistral)
- ğŸ’¾ Guarda el resultado en la colecciÃ³n `pages`
- ğŸ—‘ï¸ Borra el item de la cola

---

## ğŸš€ Uso

### Endpoint 1: Subir imagen a la cola
```bash
POST https://deberes.logise1123.workers.dev/process
Content-Type: multipart/form-data

Campos:
- image: archivo de imagen
- subject: nombre de la asignatura
- page: nÃºmero de pÃ¡gina
- userName: nombre del usuario
```

**Respuesta:**
```json
{
  "status": "queued",
  "message": "Image added to processing queue",
  "queueId": "projects/.../queue/abc123"
}
```

### Endpoint 2: Procesar una imagen de la cola
```bash
GET https://deberes.logise1123.workers.dev/work
```

**Respuesta (si hay items en cola):**
```json
{
  "status": "completed",
  "message": "Item processed and removed from queue",
  "processed": {
    "subject": "MatemÃ¡ticas",
    "page": 42,
    "providedBy": "Juan"
  }
}
```

**Respuesta (si la cola estÃ¡ vacÃ­a):**
```json
{
  "status": "idle",
  "message": "No items in queue"
}
```

---

## â° AutomatizaciÃ³n: Procesar cada 10 minutos

Tienes varias opciones para automatizar las peticiones cada 10 minutos:

### OpciÃ³n 1: Cron-job.org (Recomendado)
1. Ve a https://cron-job.org/
2. RegÃ­strate gratis
3. Crea un nuevo cron job:
   - URL: `https://deberes.logise1123.workers.dev/work`
   - MÃ©todo: GET
   - Frecuencia: Cada 10 minutos (*/10 * * * *)

### OpciÃ³n 2: GitHub Actions (Gratis)
Crea `.github/workflows/process-queue.yml` en un repositorio:
```yaml
name: Process Queue
on:
  schedule:
    - cron: '*/10 * * * *'  # Cada 10 minutos
  workflow_dispatch:  # Manual trigger

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Process one item
        run: curl -X GET https://deberes.logise1123.workers.dev/work
```

### OpciÃ³n 3: EasyCron
1. Ve a https://www.easycron.com/
2. RegÃ­strate (plan gratuito disponible)
3. Crea un cron job para hacer GET cada 10 minutos

### OpciÃ³n 4: Cloudflare Workers Cron (MEJOR)
Si usas Cloudflare Workers, puedes aÃ±adir un cron trigger directamente:

En `wrangler.toml`:
```toml
[triggers]
crons = ["*/10 * * * *"]
```

Y modificar el worker para que ejecute automÃ¡ticamente:
```javascript
export default {
  async scheduled(event, env, ctx) {
    // Llamar a la lÃ³gica de /work automÃ¡ticamente
    await processOneFromQueue();
  }
}
```

### OpciÃ³n 5: Script local (Windows)
Guarda esto como `process_queue.bat`:
```batch
@echo off
:loop
curl -X GET https://deberes.logise1123.workers.dev/work
timeout /t 600 /nobreak
goto loop
```

Ejecuta el script y lo dejarÃ¡ corriendo cada 10 minutos (600 segundos).

---

## ğŸ“Š Monitoreo

### Ver cuÃ¡ntos items hay en la cola
Puedes ver directamente en Firebase Console:
- ColecciÃ³n: `queue`
- Cada documento es una tarea pendiente

### Health Check
```bash
GET https://deberes.logise1123.workers.dev/health
```

---

## ğŸ”„ Flujo Completo

```
Usuario toma foto
    â†“
App.js llama POST /process
    â†“
Worker guarda en cola (queue)
    â†“
[10 minutos despuÃ©s]
    â†“
Cron job llama GET /work
    â†“
Worker procesa imagen aleatoria
    â†“
Resultado guardado en pages
    â†“
Item borrado de queue
    â†“
Usuario ve la soluciÃ³n en la app
```

---

## ğŸ¯ Ventajas de este sistema

âœ… **InstantÃ¡neo**: Usuario no espera mientras se procesa
âœ… **Distribuido**: Procesa las imÃ¡genes gradualmente
âœ… **Resiliente**: Si falla una, las demÃ¡s siguen en cola
âœ… **Controlado**: Puedes ajustar la frecuencia de procesamiento
âœ… **Sin lÃ­mites**: No hay timeout de 30 segundos del worker

---

## ğŸ› ï¸ Estructura Firebase

### ColecciÃ³n `queue` (cola de trabajo)
```json
{
  "subject": "MatemÃ¡ticas",
  "page": 42,
  "imageUrl": "https://greenbase.../file/abc123",
  "providedBy": "Juan",
  "queuedAt": "2026-02-12T22:00:00Z",
  "status": "pending"
}
```

### ColecciÃ³n `pages` (pÃ¡ginas procesadas)
```json
{
  "subject": "MatemÃ¡ticas",
  "page": 42,
  "imageUrl": "https://greenbase.../file/abc123",
  "solution": [{"exercise": "1", "question": "...", "solution": "..."}],
  "providedBy": "Juan",
  "timestamp": "2026-02-12T22:10:00Z"
}
```
